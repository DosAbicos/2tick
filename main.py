from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from supabase import create_client
import asyncio
import os

BOT_TOKEN = os.getenv("API_TOKEN")
SUPABASE_URL = os.getenv("SUPABASE_URL")
SUPABASE_KEY = os.getenv("SUPABASE_KEY")

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()
supabase = create_client(SUPABASE_URL, SUPABASE_KEY)

@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    telegram_id = message.from_user.id
    username = message.from_user.username
    response = supabase.table("users").select("id").eq("telegram_id", telegram_id).execute()
    if len(response.data) == 0:
        supabase.table("users").insert({
            "telegram_id": telegram_id,
            "username": username
        }).execute()
    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É", callback_data="add_task")],
            [InlineKeyboardButton(text="üìÑ –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–¥–∞—á", callback_data="view_tasks")]
        ]
    )
    await message.answer("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Totick!", reply_markup=keyboard)

@dp.callback_query(lambda c: c.data == "add_task")
async def add_task(callback: types.CallbackQuery):
    await callback.message.answer("–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞—á—É:")
    dp.message.register(wait_for_task)

async def wait_for_task(message: types.Message):
    telegram_id = message.from_user.id
    response = supabase.table("users").select("id").eq("telegram_id", telegram_id).execute()
    if len(response.data) > 0:
        user_id = response.data[0]["id"]
        supabase.table("tasks").insert({
            "user_id": user_id,
            "text": message.text,
            "status": "üîÑ –í –ø—Ä–æ—Ü–µ—Å—Å–µ"
        }).execute()
        await message.answer("–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!")
    else:
        await message.answer("–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã.")

@dp.callback_query(lambda c: c.data == "view_tasks")
async def view_tasks(callback: types.CallbackQuery):
    telegram_id = callback.from_user.id
    response = supabase.table("users").select("id").eq("telegram_id", telegram_id).execute()
    if len(response.data) > 0:
        user_id = response.data[0]["id"]
        tasks = supabase.table("tasks").select("text", "status").eq("user_id", user_id).execute().data
        if len(tasks) == 0:
            await callback.message.answer("–£ –≤–∞—Å –Ω–µ—Ç –∑–∞–¥–∞—á.")
        else:
            tasks_list = "\n".join([f"{task['text']} - {task['status']}" for task in tasks])
            await callback.message.answer(f"–í–∞—à–∏ –∑–∞–¥–∞—á–∏:\n{tasks_list}")
    else:
        await callback.message.answer("–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã.")

async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
