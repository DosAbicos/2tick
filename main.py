from aiogram import Bot, Dispatcher, types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.filters import Command
import asyncio
import os
from supabase import create_client

SUPABASE_URL = os.getenv("SUPABASE_URL")
SUPABASE_KEY = os.getenv("SUPABASE_KEY")
API_TOKEN = os.getenv("API_TOKEN")

supabase = create_client(SUPABASE_URL, SUPABASE_KEY)

bot = Bot(token=API_TOKEN)
dp = Dispatcher()

# –ö–Ω–æ–ø–∫–∏
add_task_button = InlineKeyboardMarkup(
    inline_keyboard=[[InlineKeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É", callback_data="add_task")],
                     [InlineKeyboardButton(text="üëÄ –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–¥–∞—á", callback_data="view_tasks")]]
)

@dp.message(Command("start"))
async def start(message: types.Message):
    await message.answer("–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∞–º–∏. –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=add_task_button)

@dp.callback_query(lambda c: c.data == "add_task")
async def add_task(callback_query: types.CallbackQuery):
    await callback_query.message.answer("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏:")
    await bot.answer_callback_query(callback_query.id)

    @dp.message()
    async def task_text(message: types.Message):
        global task_text
        task_text = message.text
        category_buttons = InlineKeyboardMarkup(
            inline_keyboard=[
                [InlineKeyboardButton(text="üî• –°—Ä–æ—á–Ω—ã–µ", callback_data="üî•"),
                 InlineKeyboardButton(text="‚úÖ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ", callback_data="‚úÖ")],
                [InlineKeyboardButton(text="üîÅ –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ", callback_data="üîÅ"),
                 InlineKeyboardButton(text="‚ùå –£–¥–∞–ª–µ–Ω–Ω—ã–µ", callback_data="‚ùå")]
            ]
        )
        await message.answer(f"–í—ã –≤–≤–µ–ª–∏ –∑–∞–¥–∞—á—É: {task_text}\n–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:", reply_markup=category_buttons)

@dp.callback_query(lambda c: c.data in ["üî•", "‚úÖ", "üîÅ", "‚ùå"])
async def category(callback_query: types.CallbackQuery):
    status = callback_query.data
    user_id = callback_query.from_user.id
    await callback_query.message.answer(f"‚úÖ –ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é {status}!")
    await bot.answer_callback_query(callback_query.id)
    supabase.table("tasks").insert({
        "user_id": str(user_id),
        "text": task_text,
        "status": status
    }).execute()

@dp.callback_query(lambda c: c.data == "view_tasks")
async def view_tasks(callback_query: types.CallbackQuery):
    user_id = str(callback_query.from_user.id)
    data = supabase.table("tasks").select("text, status").eq("user_id", user_id).execute()
    tasks = data.data

    if tasks:
        tasks_text = "\n".join([f"{task['status']} {task['text']}" for task in tasks])
        await callback_query.message.answer(f"–í–∞—à–∏ –∑–∞–¥–∞—á–∏:\n{tasks_text}")
    else:
        await callback_query.message.answer("–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á.")

    await bot.answer_callback_query(callback_query.id)

async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
