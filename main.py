from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command, CallbackQuery
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from apscheduler.schedulers.asyncio import AsyncIOScheduler
import asyncio
import os
from supabase import create_client, Client

API_TOKEN = os.getenv("API_TOKEN")
ADMIN_ID = int(os.getenv("ADMIN_ID"))
SUPABASE_URL = os.getenv("SUPABASE_URL")
SUPABASE_KEY = os.getenv("SUPABASE_KEY")

supabase: Client = create_client(SUPABASE_URL, SUPABASE_KEY)

bot = Bot(token=API_TOKEN)
dp = Dispatcher()
scheduler = AsyncIOScheduler()

CATEGORY_BUTTONS = [
    InlineKeyboardButton(text="üî• –°—Ä–æ—á–Ω—ã–µ", callback_data="urgent"),
    InlineKeyboardButton(text="‚úÖ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ", callback_data="planned"),
    InlineKeyboardButton(text="üîÅ –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ", callback_data="delegated"),
    InlineKeyboardButton(text="‚ùå –£–¥–∞–ª–µ–Ω–Ω—ã–µ", callback_data="deleted")
]

CATEGORY_KEYBOARD = InlineKeyboardMarkup(inline_keyboard=[CATEGORY_BUTTONS])


@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    user_id = message.from_user.id
    username = message.from_user.username
    await register_user(user_id, username)
    buttons = [
        InlineKeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É", callback_data="add_task"),
        InlineKeyboardButton(text="üìã –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–¥–∞—á", callback_data="view_tasks")
    ]
    keyboard = InlineKeyboardMarkup(inline_keyboard=[[button] for button in buttons])
    await message.answer("–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∞–º–∏. –í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=keyboard)


async def register_user(user_id, username):
    data, _ = supabase.table("users").select("*").eq("id", user_id).execute()
    if len(data) == 0:
        supabase.table("users").insert({"id": user_id, "username": username}).execute()


@dp.callback_query(CallbackQuery("add_task"))
async def add_task(callback: types.CallbackQuery):
    await callback.message.answer("–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞—á—É —Ç–µ–∫—Å—Ç–æ–º")


@dp.message()
async def process_task(message: types.Message):
    user_id = message.from_user.id
    task_text = message.text
    buttons = [
        InlineKeyboardButton(text="üî• –°—Ä–æ—á–Ω—ã–µ", callback_data=f"category:urgent:{task_text}"),
        InlineKeyboardButton(text="‚úÖ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ", callback_data=f"category:planned:{task_text}"),
        InlineKeyboardButton(text="üîÅ –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ", callback_data=f"category:delegated:{task_text}"),
        InlineKeyboardButton(text="‚ùå –£–¥–∞–ª–µ–Ω–Ω—ã–µ", callback_data=f"category:deleted:{task_text}")
    ]
    keyboard = InlineKeyboardMarkup(inline_keyboard=[[button] for button in buttons])
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è –∑–∞–¥–∞—á–∏:", reply_markup=keyboard)


@dp.callback_query(CallbackQuery(lambda c: c.data.startswith("category:")))
async def process_category(callback: types.CallbackQuery):
    _, category, task_text = callback.data.split(":")
    user_id = callback.from_user.id
    supabase.table("tasks").insert({"user_id": user_id, "text": task_text, "category": category}).execute()
    await callback.message.answer(f"–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é {category}")
    await callback.answer()


@dp.callback_query(CallbackQuery("view_tasks"))
async def view_tasks(callback: types.CallbackQuery):
    user_id = callback.from_user.id
    data, _ = supabase.table("tasks").select("text", "category").eq("user_id", user_id).execute()
    if len(data) == 0:
        await callback.message.answer("–£ –≤–∞—Å –Ω–µ—Ç –∑–∞–¥–∞—á")
    else:
        tasks = "\n".join([f"{task['category']}: {task['text']}" for task in data])
        await callback.message.answer(f"–í–∞—à–∏ –∑–∞–¥–∞—á–∏:\n{tasks}")
    await callback.answer()


async def send_reminders():
    data, _ = supabase.table("tasks").select("user_id", "text").eq("category", "urgent").execute()
    for task in data:
        user_id = task["user_id"]
        task_text = task["text"]
        await bot.send_message(user_id, f"–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –∑–∞–¥–∞—á–µ: {task_text}")


scheduler.add_job(send_reminders, "interval", hours=1)
scheduler.start()

if __name__ == "__main__":
    asyncio.run(dp.start_polling(bot))
