import React, { useState, useEffect, useRef } from 'react';
import { useNavigate, useSearchParams } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import axios from 'axios';
import { toast } from 'sonner';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import Header from '@/components/Header';
import { ArrowLeft, Eye, Edit3, Upload, Bold, Italic, Underline, Type, AlignLeft, AlignCenter, AlignRight, CheckCircle } from 'lucide-react';
import { IMaskInput } from 'react-imask';

const BACKEND_URL = process.env.REACT_APP_BACKEND_URL;
const API = `${BACKEND_URL}/api`;

const CreateContractPage = () => {
  const { t } = useTranslation();
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();
  const templateId = searchParams.get('template_id');
  
  const [loading, setLoading] = useState(false);
  const [loadingTemplate, setLoadingTemplate] = useState(false);
  const token = localStorage.getItem('token');
  
  // Template data from marketplace
  const [selectedTemplate, setSelectedTemplate] = useState(null);
  const [placeholderValues, setPlaceholderValues] = useState({});
  
  // Next contract number (for display)
  const [nextContractNumber, setNextContractNumber] = useState(null);
  
  // Manual editing mode
  const [manualEditMode, setManualEditMode] = useState(false);
  const [manualContent, setManualContent] = useState('');
  const [isContentSaved, setIsContentSaved] = useState(false);
  
  // Optional fields visibility
  const [showOptionalFields, setShowOptionalFields] = useState(false);
  
  // Tenant document upload (optional for landlord to upload)
  const [tenantDocument, setTenantDocument] = useState(null);
  const [tenantDocPreview, setTenantDocPreview] = useState(null);
  const [uploadingDoc, setUploadingDoc] = useState(false);
  
  // Template fields
  const [templateData, setTemplateData] = useState({
    // Contract info - contract_number will be generated by backend
    contract_date: new Date().toISOString().split('T')[0],
    
    // Landlord (Creator) info
    landlord_name: '–ò–ü "RentDomik"',
    landlord_representative: '', // –ö—Ç–æ —Å–æ—Å—Ç–∞–≤–∏–ª –¥–æ–≥–æ–≤–æ—Ä
    
    // Tenant (Signer) info
    tenant_name: '',
    tenant_phone: '',
    tenant_email: '',
    
    // Property details
    property_address: '',
    
    // Financial terms
    rent_amount: '',
    rent_currency: '—Ç–µ–Ω–≥–µ',
    security_deposit: '',
    
    // Dates
    move_in_date: '',
    move_out_date: '',
    
    // Additional terms
    days_count: '0',
    payment_method: '–Ω–∞–ª–∏—á–Ω—ã–º–∏',
    
    // Contract type
    contract_type: 'rent' // rent, service, purchase
  });

  // Calculate days automatically
  const calculateDays = (moveIn, moveOut) => {
    if (!moveIn || !moveOut) return 0;
    
    // Parse dates and set times: check-in at 14:00, check-out at 12:00
    const checkInDate = new Date(moveIn);
    checkInDate.setHours(14, 0, 0, 0);
    
    const checkOutDate = new Date(moveOut);
    checkOutDate.setHours(12, 0, 0, 0);
    
    // Calculate difference in milliseconds
    const diffMs = checkOutDate - checkInDate;
    
    // Convert to days (1 day = 24 hours = 86400000 ms)
    const days = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
    
    return days > 0 ? days : 0;
  };

  const handleFieldChange = (field, value) => {
    setTemplateData(prev => {
      const newData = { ...prev, [field]: value };
      
      // Auto-calculate days when dates change
      if (field === 'move_in_date' || field === 'move_out_date') {
        newData.days_count = calculateDays(
          field === 'move_in_date' ? value : prev.move_in_date,
          field === 'move_out_date' ? value : prev.move_out_date
        ).toString();
      }
      
      return newData;
    });
  };

  const editorRef = useRef(null);

  // Load next contract number on mount
  useEffect(() => {
    const fetchNextContractNumber = async () => {
      try {
        const response = await axios.get(`${API}/contracts`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const contractCount = response.data.length;
        const nextNumber = `0${contractCount + 1}`;
        setNextContractNumber(nextNumber);
      } catch (error) {
        console.error('Error fetching contract count:', error);
      }
    };
    
    fetchNextContractNumber();

    // Load template if template_id is provided
    if (templateId) {
      loadTemplateFromMarket(templateId);
    }
  }, [templateId]);

  const loadTemplateFromMarket = async (id) => {
    setLoadingTemplate(true);
    try {
      const response = await axios.get(`${API}/templates/${id}`);
      const template = response.data;
      
      setSelectedTemplate(template);
      setManualContent(template.content || '');
      
      // Initialize placeholder values
      const initialValues = {};
      if (template.placeholders) {
        Object.keys(template.placeholders).forEach(key => {
          initialValues[key] = '';
        });
      }
      setPlaceholderValues(initialValues);
      
      toast.success(`–®–∞–±–ª–æ–Ω "${template.title}" –∑–∞–≥—Ä—É–∂–µ–Ω`);
    } catch (error) {
      console.error('Error loading template:', error);
      toast.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–∞');
    } finally {
      setLoadingTemplate(false);
    }
  };

  const loadLastTemplate = () => {
    try {
      const savedTemplate = localStorage.getItem('signify_last_template');
      if (!savedTemplate) {
        toast.info('–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω–∞');
        return;
      }
      
      const template = JSON.parse(savedTemplate);
      
      // Restore template data (excluding contract_number and contract_date)
      setTemplateData(prev => ({
        ...prev,
        landlord_name: template.landlord_name || prev.landlord_name,
        landlord_representative: template.landlord_representative || prev.landlord_representative,
        tenant_name: template.tenant_name || '',
        tenant_phone: template.tenant_phone || '',
        tenant_email: template.tenant_email || '',
        property_address: template.property_address || prev.property_address,
        rent_amount: template.rent_amount || prev.rent_amount,
        rent_currency: template.rent_currency || prev.rent_currency,
        security_deposit: template.security_deposit || prev.security_deposit,
        move_in_date: template.move_in_date || prev.move_in_date,
        move_out_date: template.move_out_date || prev.move_out_date,
        days_count: template.days_count || prev.days_count,
        payment_method: template.payment_method || prev.payment_method,
        contract_type: template.contract_type || prev.contract_type
      }));
      
      // Restore saved content if exists
      if (template.isContentSaved && template.savedContent) {
        setManualContent(template.savedContent);
        setIsContentSaved(true);
      }
      
      const savedDate = new Date(template.savedAt).toLocaleString('ru-RU');
      toast.success(`–®–∞–±–ª–æ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω (—Å–æ—Ö—Ä–∞–Ω–µ–Ω ${savedDate})`);
    } catch (error) {
      console.error('Error loading template:', error);
      toast.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —à–∞–±–ª–æ–Ω–∞');
    }
  };

  const toggleEditMode = () => {
    if (!manualEditMode) {
      // If content was already saved, use it; otherwise generate new
      if (!isContentSaved) {
        const content = generatePreviewContent();
        // –ü—Ä–æ—Å—Ç–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –≤ <br>, –ë–ï–ó –ø–æ–¥—Å–≤–µ—Ç–∫–∏
        setManualContent(content.replace(/\n/g, '<br>'));
      }
      // –ï—Å–ª–∏ isContentSaved = true, manualContent —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
    }
    setManualEditMode(!manualEditMode);
  };

  const handleSaveContent = () => {
    if (editorRef.current) {
      const savedContent = editorRef.current.innerHTML;
      setManualContent(savedContent);
      setIsContentSaved(true);
      setManualEditMode(false); // Return to form after saving
      toast.success('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
    }
  };

  const executeCommand = (command, value = null) => {
    document.execCommand(command, false, value);
  };

  const changeFontSize = (size) => {
    document.execCommand('fontSize', '7');
    const fontElements = editorRef.current?.querySelectorAll('font[size="7"]');
    fontElements?.forEach(el => {
      el.removeAttribute('size');
      el.style.fontSize = size;
    });
  };

  const handleTenantDocUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    setTenantDocument(file);
    
    // Create preview
    const reader = new FileReader();
    reader.onloadend = () => {
      setTenantDocPreview(reader.result);
    };
    reader.readAsDataURL(file);
    
    toast.success('–î–æ–∫—É–º–µ–Ω—Ç –∫–ª–∏–µ–Ω—Ç–∞ –≤—ã–±—Ä–∞–Ω');
  };


  const formatDateToDDMMYYYY = (dateStr) => {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}.${month}.${year}`;
  };

  const generatePreviewContent = () => {
    // If template is selected, use template content with replaced placeholders
    if (selectedTemplate && selectedTemplate.content) {
      let content = selectedTemplate.content;
      
      // Replace placeholders with actual values
      if (selectedTemplate.placeholders) {
        Object.entries(selectedTemplate.placeholders).forEach(([key, config]) => {
          let value = placeholderValues[key] || `[${config.label}]`;
          
          // Format dates to DD.MM.YYYY
          if (config.type === 'date' && placeholderValues[key]) {
            value = formatDateToDDMMYYYY(placeholderValues[key]);
          }
          
          const regex = new RegExp(`{{${key}}}`, 'g');
          
          // For calculated fields, compute the value
          if (config.type === 'calculated' && config.formula) {
            const { operand1, operation, operand2 } = config.formula;
            
            let result = 0;
            
            if (operation === 'days_between') {
              // Date calculation
              if (placeholderValues[operand1] && placeholderValues[operand2]) {
                const date1 = new Date(placeholderValues[operand1]);
                const date2 = new Date(placeholderValues[operand2]);
                const diffTime = Math.abs(date2 - date1);
                result = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
              }
            } else {
              // Numerical calculation
              const val1 = parseFloat(placeholderValues[operand1]) || 0;
              const val2 = parseFloat(placeholderValues[operand2]) || 0;
              
              switch(operation) {
                case 'add': result = val1 + val2; break;
                case 'subtract': result = val1 - val2; break;
                case 'multiply': result = val1 * val2; break;
                case 'divide': result = val2 !== 0 ? val1 / val2 : 0; break;
                case 'modulo': result = val2 !== 0 ? val1 % val2 : 0; break;
                default: result = 0;
              }
            }
            
            content = content.replace(regex, result.toString() || `[${config.label}]`);
          } else {
            content = content.replace(regex, value);
          }
        });
      }
      
      return content;
    }
    
    // Fallback to old template generation
    return generateContractContent();
  };

  const generateContractContent = () => {
    const { 
      contract_date,
      landlord_name,
      landlord_representative,
      tenant_name,
      property_address,
      rent_amount,
      rent_currency,
      security_deposit,
      move_in_date,
      move_out_date,
      days_count,
      payment_method
    } = templateData;

    return `–î–û–ì–û–í–û–† –ö–†–ê–¢–ö–û–°–†–û–ß–ù–û–ì–û –ù–ê–ô–ú–ê –ñ–ò–õ–û–ì–û –ü–û–ú–ï–©–ï–ù–ò–Ø

${contract_date}

–ú—ã, –Ω–∏–∂–µ–ø–æ–¥–ø–∏—Å–∞–≤—à–∏–µ—Å—è, ${landlord_name}, –∏–º–µ–Ω—É–µ–º—ã–π –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º ¬´–ù–∞–π–º–æ–¥–∞—Ç–µ–ª—å¬ª, —Å –æ–¥–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã, –∏ –≥—Ä–∞–∂–¥–∞–Ω–∏–Ω ${tenant_name || '[–§–ò–û –ù–∞–Ω–∏–º–∞—Ç–µ–ª—è]'} (–û–ö–ü–û —Ç—Ä–ª–Ω–∞—Ç—Ç.–Ω–¥—Ç), –∏–º–µ–Ω—É–µ–º—ã–π –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º ¬´–ù–∞–Ω–∏–º–∞—Ç–µ–ª—å¬ª, —Å –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã, —Å–æ–≤–º–µ—Å—Ç–Ω–æ –∏–º–µ–Ω—É–µ–º—ã–µ ¬´–°—Ç–æ—Ä–æ–Ω—ã¬ª, –∑–∞–∫–ª—é—á–∏–ª–∏ –Ω–∞—Å—Ç–æ—è—â–∏–π –î–æ–≥–æ–≤–æ—Ä –æ –Ω–∏–∂–µ—Å–ª–µ–¥—É—é—â–µ–º:

1. –ü—Ä–µ–¥–º–µ—Ç –î–æ–≥–æ–≤–æ—Ä–∞

1.1. –ù–∞–π–º–æ–¥–∞—Ç–µ–ª—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç, –∞ –ù–∞–Ω–∏–º–∞—Ç–µ–ª—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –ø–ª–∞—Ç–Ω–æ–µ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∂–∏–ª–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ –ø–æ –∞–¥—Ä–µ—Å—É: ${property_address || '[–ê–¥—Ä–µ—Å –∫–≤–∞—Ä—Ç–∏—Ä—ã]'}.

1.2. –ñ–∏–ª–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –Ω–∞–π–º –Ω–∞ —Å—Ä–æ–∫ —Å ${move_in_date || '[–î–∞—Ç–∞ –∑–∞—Å–µ–ª–µ–Ω–∏—è]'} –ø–æ ${move_out_date || '[–î–∞—Ç–∞ –≤—ã—Å–µ–ª–µ–Ω–∏—è]'}, —á—Ç–æ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç ${days_count || '[–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—É—Ç–æ–∫]'} —Å—É—Ç–æ–∫.

–î–∞—Ç–∞ –∑–∞—Å–µ–ª–µ–Ω–∏—è: —Å 14:00, ${move_in_date || '[–î–∞—Ç–∞ –∑–∞—Å–µ–ª–µ–Ω–∏—è]'}
–î–∞—Ç–∞ –≤—ã—Å–µ–ª–µ–Ω–∏—è: –¥–æ 12:00, ${move_out_date || '[–î–∞—Ç–∞ –≤—ã—Å–µ–ª–µ–Ω–∏—è]'}

1.3. –ü—Ä–∞–≤–æ —Ä–∞—Å–ø–æ—Ä—è–∂–∞—Ç—å—Å—è –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∂–∏–ª—ã–º –ø–æ–º–µ—â–µ–Ω–∏–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏: –î–æ–≥–æ–≤–æ—Ä –¥–æ–ª–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.

1.4. –ü–æ–º–∏–º–æ –ù–∞–Ω–∏–º–∞—Ç–µ–ª—è –≤ –∂–∏–ª–æ–º –ø–æ–º–µ—â–µ–Ω–∏–∏ –±—É–¥–µ—Ç –ø—Ä–æ–∂–∏–≤–∞—Ç—å: ${days_count || '[–ö—Ç–æ –µ—â–µ –±—É–¥–µ—Ç –ø—Ä–æ–∂–∏–≤–∞—Ç—å]'}.

2. –ü–ª–∞—Ç–∞ –∑–∞ –Ω–∞–π–º

2.1. –ó–∞ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∂–∏–ª—ã–º –ø–æ–º–µ—â–µ–Ω–∏–µ–º —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø–ª–∞—Ç–∞ –≤ —Ä–∞–∑–º–µ—Ä–µ ${rent_amount || '[–¶–µ–Ω–∞ –≤ —Å—É—Ç–∫–∏]'} ${rent_currency} –≤ —Å—É—Ç–∫–∏.

2.2. –ü—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –≤–Ω–æ—Å–∏—Ç—Å—è –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –∑–∞ –±—Ä–æ–Ω—å –≤ —Ä–∞–∑–º–µ—Ä–µ ${security_deposit || '[–û–ø–ª–∞—á–µ–Ω–æ]'}.

2.3. –ü–æ–ª–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã - ${rent_amount ? (parseInt(rent_amount) * parseInt(days_count || 1)) : '[–ü–æ–ª–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å]'} ${rent_currency}. –î–∞–Ω–Ω–∞—è —Å—É–º–º–∞ —É–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è –ù–∞–Ω–∏–º–∞—Ç–µ–ª–µ–º –∏ –ø–æ–ª–Ω–æ–º –æ–±—ä–µ–º–µ –ø—Ä–∏ –∑–∞—Å–µ–ª–µ–Ω–∏–∏ –≤ –∂–∏–ª–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ –∏–ª–∏ –∑–∞—Ä–∞–Ω–µ–µ –±–µ–∑–Ω–∞–ª–∏—á–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º.

2.4. –ü—Ä–∏ –≤—ä–µ–∑–¥–µ –≤–Ω–æ—Å–∏—Ç—Å—è –æ–±–µ—Å–ø–µ—á–∏—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂ –≤ —Ä–∞–∑–º–µ—Ä–µ ${security_deposit || '[–û–±–µ—Å–ø–µ—á–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç]'}, –∑–∞ —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å –∏–º—É—â–µ—Å—Ç–≤–∞ –∏ –ø–æ–ª–Ω–æ–º –æ–±—ä–µ–º–µ –ø—Ä–∏ –≤—ã—Å–µ–ª–µ–Ω–∏–∏. –î–∞–Ω–Ω—ã–π –ø–ª–∞—Ç—ë–∂ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –ø–æ–ª–Ω–æ–º –æ–±—ä–µ–º–µ –ø—Ä–∏ –≤—ã—Å–µ–ª–µ–Ω–∏–∏.

2.5. –î–ª—è —Ü–µ–ª–µ–π –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –î–æ–≥–æ–≤–æ—Ä–∞ –∏—Å—á–∏—Å–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã—Ö —Å—É—Ç–æ–∫ –Ω–∞–π–º–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 14.30, –≤ —Å–ª—É—á–∞–µ –±–æ–ª–µ–µ –ø–æ–∑–¥–Ω–µ–≥–æ –∑–∞—Å–µ–ª–µ–Ω–∏—è —Å–æ –¥–Ω—è –∏ —á–∞—Å–∞ –∑–∞—Å–µ–ª–µ–Ω–∏—è. –ù–µ–ø–æ–ª–Ω—ã–µ —Å—É—Ç–∫–∏ –Ω–∞–π–º–∞, –æ–±—Ä–∞–∑–æ–≤–∞–≤—à–∏–µ—Å—è –≤ —Å–ª—É—á–∞–µ –∑–∞—Å–µ–ª–µ–Ω–∏—è –ø–æ–∑–¥–Ω–µ–µ 14.30 –∏–ª–∏ –≤—ã—Å–µ–ª–µ–Ω–∏—è —Ä–∞–Ω–µ–µ 12.00, –æ–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è, –Ω–æ –Ω–µ –º–µ–Ω–µ–µ 50% —Å—É—Ç–æ—á–Ω–æ–π –ø–ª–∞—Ç—ã –∑–∞ –Ω–∞–π–º —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è —Å–æ–≥–ª–∞—Å–Ω–æ —Ç–∞—Ä–∏—Ñ–∞.

2.6. –í —Å–æ—Å—Ç–∞–≤ –ø–ª–∞—Ç—ã –∑–∞ –Ω–∞–π–º —Ä–∞—Å—Ö–æ–¥–æ–≤ –ù–∞–π–º–æ–¥–∞—Ç–µ–ª—è –ø–æ –æ–ø–ª–∞—Ç–µ –∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã—Ö —É—Å–ª—É–≥.

2.7. –í —Å–ª—É—á–∞–µ –¥–æ—Å—Ä–æ—á–Ω–æ–≥–æ —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏—è, —Ä–∞–Ω–µ–µ –æ–≥–æ–≤–æ—Ä–µ–Ω–Ω—ã—Ö —Å—Ä–æ–∫–æ–≤ –Ω–∞–π–º–∞ –∂–∏–ª–æ–≥–æ –ø–æ–º–µ—â–µ–Ω–∏—è, —Å—É–º–º–∞ –∞—Ä–µ–Ω–¥–Ω–æ–π –ø–ª–∞—Ç—ã –ø–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—é —Å—Ç–æ—Ä–æ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–∞ –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –ø—Ä–∏—á–∏–Ω, –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –¥–µ–Ω–µ–∂–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –∑–∞ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏–µ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è.

3. –ü—Ä–∞–≤–∞ –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ —Å—Ç–æ—Ä–æ–Ω

3.1. –ü—Ä–∞–≤–∞ –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ –ù–∞–π–º–æ–¥–∞—Ç–µ–ª—è:

3.1.1. –ù–∞–π–º–æ–¥–∞—Ç–µ–ª—å –æ–±—è–∑—É–µ—Ç—Å—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –ù–∞–Ω–∏–º–∞—Ç–µ–ª—é –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∂–∏–ª—ã–º –ø–æ–º–µ—â–µ–Ω–∏–µ–º –≤–º–µ—Å—Ç–µ —Å –º–µ–±–µ–ª—å—é, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–π –±—ã—Ç–æ–≤–æ–π —Ç–µ—Ö–Ω–∏–∫–æ–π, –ø–æ—Å—É–¥–æ–π, –∫—É—Ö–æ–Ω–Ω—ã–º–∏ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—è–º–∏ –∏ –ø–æ—Å—Ç–µ–ª—å–Ω—ã–º –±–µ–ª—å–µ–º.

3.1.2. –ü–µ—Ä–µ–¥–∞—Ç—å –ù–∞–Ω–∏–º–∞—Ç–µ–ª—é –ø–æ–ª–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Ç –∫–ª—é—á–µ–π –æ—Ç –∂–∏–ª–æ–≥–æ –ø–æ–º–µ—â–µ–Ω–∏—è, –ø–æ–¥—ä–µ–∑–¥–∞ –∏ —ç—Ç–∞–∂–∞, –∏ –≤ —Å–ª—É—á–∞–µ –µ—Å–ª–∏ —Ç–∞–∫–æ–≤–æ–π —É—Ç–µ—Ä—è–Ω –∏–ª–∏ –æ—Å—Ç–∞–≤–ª–µ–Ω –≤–Ω—É—Ç—Ä–∏ –ø–æ–º–µ—â–µ–Ω–∏—è –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç–∫—Ä—ã—Ç—å —Å–Ω–∞—Ä—É–∂–∏.

3.1.3. –£—Å—Ç—Ä–∞–Ω–∏—Ç—å –≤ –∂–∏–ª–æ–º –ø–æ–º–µ—â–µ–Ω–∏–∏ –ø–æ–ª–æ–º–∫–∏, –∞–≤–∞—Ä–∏–∏ –∏ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–∏, –ø—Ä–æ–∏–∑–æ—à–µ–¥—à–∏–µ –Ω–µ –ø–æ –≤–∏–Ω–µ –ù–∞–Ω–∏–º–∞—Ç–µ–ª—è.

3.1.4. –ù–∞–π–º–æ–¥–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –æ—Å—É—â–µ—Å—Ç–≤–ª—è—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ—Ä—è–¥–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ù–∞–Ω–∏–º–∞—Ç–µ–ª–µ–º –∂–∏–ª–æ–≥–æ –ø–æ–º–µ—â–µ–Ω–∏—è –±–µ–∑ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è —Å –ù–∞–Ω–∏–º–∞—Ç–µ–ª–µ–º.

3.2. –ü—Ä–∞–≤–∞ –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ –ù–∞–Ω–∏–º–∞—Ç–µ–ª—è:

3.2.1. –ù–∞–Ω–∏–º–∞—Ç–µ–ª—å –≤–ø—Ä–∞–≤–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∂–∏–ª—ã–º –ø–æ–º–µ—â–µ–Ω–∏–µ–º, –º–µ–±–µ–ª—å—é, –±—ã—Ç–æ–≤–æ–π —Ç–µ—Ö–Ω–∏–∫–æ–π, –Ω–∞—Ä—É—à–∞—Ç—å –ø—Ä–∞–≤–∞ –∏ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ —Å–æ—Å–µ–¥–µ–π, –∞ —Ç–∞–∫–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∂–∏–ª–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏.

3.2.2. –ë–µ—Ä–µ–∂–Ω–æ –æ—Ç–Ω–æ—Å–∏—Ç—å—Å—è –∫ –∏–º—É—â–µ—Å—Ç–≤—É –ù–∞–π–º–æ–¥–∞—Ç–µ–ª—è, –Ω–∞—Ö–æ–¥—è—â–µ–º—É—Å—è –≤ –∂–∏–ª–æ–º –ø–æ–º–µ—â–µ–Ω–∏–∏.

3.2.3. –ü—Ä–∏ –¥–æ—Å—Ä–æ—á–Ω–æ–º –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏–∏ –î–æ–≥–æ–≤–æ—Ä–∞ –¥–æ—Å—Ä–æ—á–Ω–æ –ù–∞–π–º–æ–¥–∞—Ç–µ–ª—é –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Ç –∫–ª—é—á–µ–π.

3.2.4. –ü—Ä–∏ –≤—ã—Å–µ–ª–µ–Ω–∏–∏ –∂–∏–ª–æ–≥–æ –ø–æ–º–µ—â–µ–Ω–∏—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –≤ –∫–æ—Ç–æ—Ä–æ–º –æ–Ω–æ –±—ã–ª–æ –Ω–∞ –º–æ–º–µ–Ω—Ç –≤—Å–µ–ª–µ–Ω–∏—è, –∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ –∏–∑–Ω–æ—Å–∞. –í —Å–ª—É—á–∞–µ –º–∞–ª–æ–π —Å–æ—Å–µ–¥–µ–π, –∂–∏–ª–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ –ø–æ–¥–ª–µ–∂–∏—Ç —Å–∞–Ω–∏—Ç–∞—Ä–Ω–æ–π —É–±–æ—Ä–∫–µ —Å–∏–ª–∞–º–∏ –ù–∞–Ω–∏–º–∞—Ç–µ–ª—è. –ü–µ—Ä–µ–¥ –æ—Ç—ä–µ–∑–¥–æ–º —Å–ª–µ–¥—É–µ—Ç –≤—ã—Å–µ–ª–µ–Ω–∏–µ –±–µ–∑ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ —Å–ª—É—á–∞–µ –Ω–µ–Ω–∞–¥–ª–µ–∂–∞—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∂–∏–ª–æ–≥–æ –ø–æ–º–µ—â–µ–Ω–∏—è.

3.2.5. –í —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ –ù–∞–Ω–∏–º–∞—Ç–µ–ª–µ–º –∑–∞–ø—Ä–µ—â–µ–Ω–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ —à—É–º–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π. –í —Å–ª—É—á–∞–µ –∂–∞–ª–æ–± —Å–æ—Å–µ–¥–µ–π, —Å–ª–µ–¥—É–µ—Ç –≤—ã—Å–µ–ª–µ–Ω–∏–µ –±–µ–∑ –≤–æ–∑–≤—Ä–∞—Ç–∞.

3.2.6. –ó–∞–ø—Ä–µ—â–µ–Ω–æ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏–µ –≤ –∂–∏–ª–æ–º –ø–æ–º–µ—â–µ–Ω–∏–∏ –ª–∏—Ü, –Ω–µ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –≤ –Ω–∞—Å—Ç–æ—è—â–µ–º –î–æ–≥–æ–≤–æ—Ä–µ. –í —Å–ª—É—á–∞–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è —ç—Ç–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞, —Å–ª–µ–¥—É–µ—Ç –≤—ã—Å–µ–ª–µ–Ω–∏–µ –±–µ–∑ –≤–æ–∑–≤—Ä–∞—Ç–∞.

3.2.7. –ó–∞–ø—Ä–µ—â–µ–Ω–æ –∫—É—Ä–µ–Ω–∏–µ –≤ –∂–∏–ª–æ–º –ø–æ–º–µ—â–µ–Ω–∏–∏. –í —Å–ª—É—á–∞–µ –≤—ã—è–≤–ª–µ–Ω–∏—è –∑–∞–ø—Ä–µ—â–∞–µ—Ç—Å—è –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä—Å–∫–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞.

4. –ü–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ–¥–∞—á–∏ –∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∂–∏–ª–æ–≥–æ –ø–æ–º–µ—â–µ–Ω–∏—è

4.1. –ü—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ –∂–∏–ª–æ–≥–æ –ø–æ–º–µ—â–µ–Ω–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∏ –≤–Ω–µ—à–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –æ—Å–º–æ—Ç—Ä –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º –ø—Ä–∏–µ–º–∞-–ø–µ—Ä–µ–¥–∞—á–∏ –∂–∏–ª–æ–≥–æ –ø–æ–º–µ—â–µ–Ω–∏—è –Ω–∞ –º–æ–º–µ–Ω—Ç –ø–µ—Ä–µ–¥–∞—á–∏ –Ω–∞–ø–∏—Å–∞–Ω—ã –ø—Ä–µ—Ç–µ–Ω–∑–∏–∏. –ü—Ä–∏–µ–º –∂–∏–ª–æ–≥–æ –ø–æ–º–µ—â–µ–Ω–∏—è –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –ù–∞–Ω–∏–º–∞—Ç–µ–ª–µ–º –ª–∏—á–Ω–æ, –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã –∏–ª–∏ —á–µ—Ä–µ–∑ –í–∞—Ç—Å–∞–ø –≤ —Ç–µ—á–µ–Ω–∏–∏ 2 —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ –∑–∞—Å–µ–ª–µ–Ω–∏—è.

4.2. –ü—Ä–∏ –≤—ã—Å–µ–ª–µ–Ω–∏–∏ –∂–∏–ª–æ–≥–æ –ø–æ–º–µ—â–µ–Ω–∏—è –ù–∞–Ω–∏–º–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –µ–≥–æ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏, –≤ –∫–æ—Ç–æ—Ä–æ–º –æ–Ω –ø–æ–ª—É—á–∏–ª, –∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ –∏–∑–Ω–æ—Å–∞. –°–∞–Ω–∏—Ç–∞—Ä–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∂–∏–ª–æ–≥–æ –ø–æ–º–µ—â–µ–Ω–∏—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–º.

5. –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –°—Ç–æ—Ä–æ–Ω

5.1. –ó–∞ –Ω–µ–∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–ª–∏ –Ω–µ–Ω–∞–¥–ª–µ–∂–∞—â–µ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤ –ø–æ –Ω–∞—Å—Ç–æ—è—â–µ–º—É –î–æ–≥–æ–≤–æ—Ä—É –°—Ç–æ—Ä–æ–Ω—ã –Ω–µ—Å—É—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ–º.

6. –ü—Ä–æ—á–∏–µ —É—Å–ª–æ–≤–∏—è

6.1. –ù–∞—Å—Ç–æ—è—â–∏–π –î–æ–≥–æ–≤–æ—Ä —Å–æ—Å—Ç–∞–≤–ª–µ–Ω –≤ –¥–≤—É—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–∞—Ö, –∏–º–µ—é—â–∏—Ö –æ–¥–∏–Ω–∞–∫–æ–≤—É—é —é—Ä–∏–¥–∏—á–µ—Å–∫—É—é —Å–∏–ª—É, –ø–æ –æ–¥–Ω–æ–º—É –¥–ª—è –∫–∞–∂–¥–æ–π –∏–∑ –°—Ç–æ—Ä–æ–Ω.

6.2. –°–ø–æ—Ä—ã –ø–æ –Ω–∞—Å—Ç–æ—è—â–µ–º—É –î–æ–≥–æ–≤–æ—Ä—É —Ä–∞–∑—Ä–µ—à–∞—é—Ç—Å—è –ø—É—Ç–µ–º –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–æ–≤, –∞ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —Å–æ–≥–ª–∞—Å–∏—è ‚Äî –≤ —Å—É–¥–µ–±–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.

7. –†–µ–∫–≤–∏–∑–∏—Ç—ã –∏ –ø–æ–¥–ø–∏—Å–∏ –°—Ç–æ—Ä–æ–Ω

–ù–∞–π–º–æ–¥–∞—Ç–µ–ª—å: ${landlord_name}
–ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å: ${landlord_representative || '[–ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å]'}

–ù–∞–Ω–∏–º–∞—Ç–µ–ª—å: ${tenant_name || '[–§–ò–û]'}
–¢–µ–ª–µ—Ñ–æ–Ω: ${templateData.tenant_phone || '[–¢–µ–ª–µ—Ñ–æ–Ω]'}
Email: ${templateData.tenant_email || '[Email]'}

–ü–æ–¥–ø–∏—Å–∏:

–ù–∞–π–º–æ–¥–∞—Ç–µ–ª—å: _____________
–ù–∞–Ω–∏–º–∞—Ç–µ–ª—å: _____________

–î–∞—Ç–∞: ${contract_date}`;
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    
    try {
      // Use saved content if available, otherwise generate from form
      let contentToSave = isContentSaved ? manualContent : (selectedTemplate ? selectedTemplate.content : generateContractContent());
      
      // Replace placeholders with actual values
      if (selectedTemplate && placeholderValues) {
        Object.entries(placeholderValues).forEach(([key, value]) => {
          const regex = new RegExp(`{{${key}}}`, 'g');
          contentToSave = contentToSave.replace(regex, value || `[${key}]`);
        });
        
        // Calculate computed fields
        if (selectedTemplate.placeholders) {
          Object.entries(selectedTemplate.placeholders).forEach(([key, config]) => {
            if (config.type === 'calculated' && config.formula) {
              const { operand1, operation, operand2 } = config.formula;
              const val1 = parseFloat(placeholderValues[operand1]) || 0;
              const val2 = parseFloat(placeholderValues[operand2]) || 0;
              
              let result = 0;
              switch(operation) {
                case 'add': result = val1 + val2; break;
                case 'subtract': result = val1 - val2; break;
                case 'multiply': result = val1 * val2; break;
                case 'divide': result = val2 !== 0 ? val1 / val2 : 0; break;
                case 'modulo': result = val2 !== 0 ? val1 % val2 : 0; break;
                case 'days_between':
                  const date1 = new Date(placeholderValues[operand1]);
                  const date2 = new Date(placeholderValues[operand2]);
                  result = Math.abs(Math.ceil((date2 - date1) / (1000 * 60 * 60 * 24)));
                  break;
                default: result = 0;
              }
              
              const regex = new RegExp(`{{${key}}}`, 'g');
              contentToSave = contentToSave.replace(regex, result.toString());
            }
          });
        }
      }
      
      // Store metadata about whether content is HTML or plain text
      const isHtmlContent = isContentSaved && manualContent.includes('<');
      
      // Extract tenant info from placeholders or templateData
      let signerName = templateData.tenant_name;
      let signerPhone = templateData.tenant_phone;
      let signerEmail = templateData.tenant_email;
      
      if (selectedTemplate && selectedTemplate.placeholders) {
        // Try to find tenant info in placeholders
        Object.entries(selectedTemplate.placeholders).forEach(([key, config]) => {
          const value = placeholderValues[key];
          if (config.type === 'text' && (key.toLowerCase().includes('tenant') || key.toLowerCase().includes('–Ω–∞–Ω–∏–º–∞—Ç–µ–ª—å'))) {
            signerName = value || signerName;
          } else if (config.type === 'phone') {
            signerPhone = value || signerPhone;
          } else if (config.type === 'email') {
            signerEmail = value || signerEmail;
          }
        });
      }
      
      const contractData = {
        title: selectedTemplate ? selectedTemplate.title : `–î–æ–≥–æ–≤–æ—Ä –æ—Ç ${templateData.contract_date}`,
        content: contentToSave,
        content_type: selectedTemplate ? selectedTemplate.content_type : (isHtmlContent ? 'html' : 'plain'),
        source_type: selectedTemplate ? 'template' : 'manual',
        template_id: selectedTemplate ? selectedTemplate.id : undefined,
        signer_name: signerName || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
        signer_phone: signerPhone || '',
        signer_email: signerEmail,
        move_in_date: templateData.move_in_date,
        move_out_date: templateData.move_out_date,
        property_address: templateData.property_address,
        rent_amount: templateData.rent_amount,
        days_count: templateData.days_count,
        amount: templateData.rent_amount ? `${parseInt(templateData.rent_amount) * parseInt(templateData.days_count || 1)} ${templateData.rent_currency}` : undefined
      };
      
      const response = await axios.post(`${API}/contracts`, contractData, {
        headers: { Authorization: `Bearer ${token}` }
      });
      
      const contractId = response.data.id;
      const contractNumber = response.data.contract_number;  // Get contract number from backend
      
      // Update contract title with proper contract number from backend
      if (contractNumber) {
        await axios.put(`${API}/contracts/${contractId}`, 
          { title: `–î–æ–≥–æ–≤–æ—Ä ‚Ññ ${contractNumber} –æ—Ç ${templateData.contract_date}` },
          { headers: { Authorization: `Bearer ${token}` }}
        );
      }
      
      // Save template to localStorage for future use
      const templateToSave = {
        ...templateData,
        savedContent: isContentSaved ? manualContent : null,
        isContentSaved: isContentSaved,
        savedAt: new Date().toISOString()
      };
      localStorage.setItem('signify_last_template', JSON.stringify(templateToSave));
      
      // Upload tenant document if selected (optional)
      if (tenantDocument) {
        setUploadingDoc(true);
        const formData = new FormData();
        formData.append('file', tenantDocument);
        
        try {
          await axios.post(`${API}/sign/${contractId}/upload-document`, formData);
          toast.success('–î–æ–≥–æ–≤–æ—Ä –∏ –¥–æ–∫—É–º–µ–Ω—Ç –∫–ª–∏–µ–Ω—Ç–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã');
        } catch (docError) {
          console.error('Document upload error:', docError);
          toast.warning('–î–æ–≥–æ–≤–æ—Ä —Å–æ–∑–¥–∞–Ω, –Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        } finally {
          setUploadingDoc(false);
        }
      } else {
        toast.success(t('common.success'));
      }
      
      navigate(`/contracts/${contractId}`);
    } catch (error) {
      toast.error(error.response?.data?.detail || t('common.error'));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-neutral-50">
      <Header />
      
      <div className="max-w-[1600px] mx-auto px-4 py-8">
        <Button
          variant="ghost"
          onClick={() => navigate('/dashboard')}
          className="mb-6"
          data-testid="back-button"
        >
          <ArrowLeft className="mr-2 h-4 w-4" />
          Back to Dashboard
        </Button>
        
        <div className="mb-6">
          <h1 className="text-3xl font-bold text-neutral-900">{t('contract.create.title')}</h1>
          {loadingTemplate && (
            <div className="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
              <p className="text-sm text-blue-800">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–∞...</p>
            </div>
          )}
          {selectedTemplate && (
            <div className="mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
              <p className="text-sm text-green-800">‚úì –®–∞–±–ª–æ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω: <strong>{selectedTemplate.title}</strong></p>
            </div>
          )}
          {nextContractNumber && (
            <p className="text-xl font-bold text-neutral-900 mt-3">
              –ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞: {nextContractNumber}
            </p>
          )}
          <p className="text-neutral-600 mt-2">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è —Å–ø—Ä–∞–≤–∞, –¥–æ–≥–æ–≤–æ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç—Å—è —Å–ª–µ–≤–∞</p>
          <div className="mt-3">
            <Button
              type="button"
              variant="outline"
              onClick={loadLastTemplate}
              className="text-sm"
            >
              üìã –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–±–ª–æ–Ω
            </Button>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Left: Contract Preview */}
          <Card className="lg:sticky lg:top-4 h-fit" data-testid="contract-preview-card">
            <CardHeader className="flex flex-row items-center justify-between">
              <CardTitle className="flex items-center gap-2">
                <Eye className="h-5 w-5" />
                {manualEditMode ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä' : '–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–≥–æ–≤–æ—Ä–∞'}
                {isContentSaved && !manualEditMode && (
                  <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">‚úì –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ</span>
                )}
              </CardTitle>
              <div className="flex gap-2">
                {!manualEditMode && (
                  <Button
                    type="button"
                    variant="outline"
                    size="sm"
                    onClick={toggleEditMode}
                  >
                    <Edit3 className="h-4 w-4 mr-2" />
                    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é
                  </Button>
                )}
                {manualEditMode && (
                  <Button
                    type="button"
                    variant="default"
                    size="sm"
                    onClick={handleSaveContent}
                  >
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                  </Button>
                )}
              </div>
            </CardHeader>
            <CardContent>
              {manualEditMode ? (
                <div className="editor-container">
                  {/* Toolbar */}
                  <div className="bg-gray-50 border border-gray-300 rounded-t-lg p-2 flex flex-wrap gap-1 items-center">
                    <Button type="button" variant="ghost" size="sm" onMouseDown={(e) => { e.preventDefault(); executeCommand('bold'); }} className="h-8 w-8 p-0" title="–ñ–∏—Ä–Ω—ã–π"><Bold className="h-4 w-4" /></Button>
                    <Button type="button" variant="ghost" size="sm" onMouseDown={(e) => { e.preventDefault(); executeCommand('italic'); }} className="h-8 w-8 p-0" title="–ö—É—Ä—Å–∏–≤"><Italic className="h-4 w-4" /></Button>
                    <Button type="button" variant="ghost" size="sm" onMouseDown={(e) => { e.preventDefault(); executeCommand('underline'); }} className="h-8 w-8 p-0" title="–ü–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π"><Underline className="h-4 w-4" /></Button>
                    
                    <div className="w-px bg-gray-300 mx-1" />
                    
                    <Button type="button" variant="ghost" size="sm" onMouseDown={(e) => { e.preventDefault(); executeCommand('formatBlock', '<h1>'); }} className="h-8 px-2" title="–ó–∞–≥–æ–ª–æ–≤–æ–∫ 1">H1</Button>
                    <Button type="button" variant="ghost" size="sm" onMouseDown={(e) => { e.preventDefault(); executeCommand('formatBlock', '<h2>'); }} className="h-8 px-2" title="–ó–∞–≥–æ–ª–æ–≤–æ–∫ 2">H2</Button>
                    <Button type="button" variant="ghost" size="sm" onMouseDown={(e) => { e.preventDefault(); executeCommand('formatBlock', '<h3>'); }} className="h-8 px-2" title="–ó–∞–≥–æ–ª–æ–≤–æ–∫ 3">H3</Button>
                    
                    <div className="w-px bg-gray-300 mx-1" />
                    
                    <Button type="button" variant="ghost" size="sm" onMouseDown={(e) => { e.preventDefault(); executeCommand('justifyLeft'); }} className="h-8 w-8 p-0" title="–ü–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é"><AlignLeft className="h-4 w-4" /></Button>
                    <Button type="button" variant="ghost" size="sm" onMouseDown={(e) => { e.preventDefault(); executeCommand('justifyCenter'); }} className="h-8 w-8 p-0" title="–ü–æ —Ü–µ–Ω—Ç—Ä—É"><AlignCenter className="h-4 w-4" /></Button>
                    <Button type="button" variant="ghost" size="sm" onMouseDown={(e) => { e.preventDefault(); executeCommand('justifyRight'); }} className="h-8 w-8 p-0" title="–ü–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é"><AlignRight className="h-4 w-4" /></Button>
                    
                    <div className="w-px bg-gray-300 mx-1" />
                    
                    <Button type="button" variant="ghost" size="sm" onMouseDown={(e) => { e.preventDefault(); executeCommand('insertUnorderedList'); }} className="h-8 px-2" title="–ú–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫">‚Ä¢ –°–ø–∏—Å–æ–∫</Button>
                    <Button type="button" variant="ghost" size="sm" onMouseDown={(e) => { e.preventDefault(); executeCommand('insertOrderedList'); }} className="h-8 px-2" title="–ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫">1. –°–ø–∏—Å–æ–∫</Button>
                    
                    <div className="w-px bg-gray-300 mx-1" />
                    
                    <select onChange={(e) => changeFontSize(e.target.value)} className="h-8 px-2 border rounded text-sm" defaultValue="14px">
                      <option value="12px">–ú–∞–ª–µ–Ω—å–∫–∏–π</option>
                      <option value="14px">–û–±—ã—á–Ω—ã–π</option>
                      <option value="16px">–ë–æ–ª—å—à–æ–π</option>
                      <option value="18px">–û–≥—Ä–æ–º–Ω—ã–π</option>
                    </select>
                  </div>
                  
                  {/* Editor */}
                  <div
                    ref={editorRef}
                    contentEditable
                    dangerouslySetInnerHTML={{ __html: manualContent }}
                    suppressContentEditableWarning
                    key={manualContent}
                    onBlur={(e) => setManualContent(e.currentTarget.innerHTML)}
                    className="min-h-[700px] p-4 border border-t-0 border-gray-300 rounded-b-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    style={{
                      fontFamily: 'IBM Plex Sans, sans-serif',
                      fontSize: '14px',
                      lineHeight: '1.6',
                      overflowY: 'auto'
                    }}
                  />
                </div>
              ) : (
                <div className="bg-white border rounded-lg p-6 max-h-[800px] overflow-y-auto" data-testid="contract-preview">
                  {isContentSaved ? (
                    <div 
                      className="prose prose-sm max-w-none"
                      style={{
                        fontFamily: 'IBM Plex Sans, sans-serif',
                        fontSize: '14px',
                        lineHeight: '1.6'
                      }}
                      dangerouslySetInnerHTML={{ __html: manualContent }}
                    />
                  ) : (
                    <div className="prose prose-sm max-w-none">
                      <pre className="whitespace-pre-wrap text-xs font-['IBM_Plex_Sans'] leading-relaxed text-neutral-800">
                        {generatePreviewContent()}
                      </pre>
                    </div>
                  )}
                </div>
              )}
            </CardContent>
          </Card>

          {/* Right: Form Fields */}
          <Card data-testid="contract-form-card">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Edit3 className="h-5 w-5" />
                –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ
              </CardTitle>
            </CardHeader>
            <CardContent>
              <form onSubmit={handleSubmit} className="space-y-6" data-testid="create-contract-form">
                {/* Contract Info */}
                <div className="space-y-4">
                  <h3 className="font-semibold text-neutral-900 border-b pb-2">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–≥–æ–≤–æ—Ä–µ</h3>
                  <div className="grid grid-cols-1 gap-4">
                    <div>
                      <Label htmlFor="contract_date">–î–∞—Ç–∞ –¥–æ–≥–æ–≤–æ—Ä–∞ *</Label>
                      <Input
                        id="contract_date"
                        type="date"
                        value={templateData.contract_date}
                        onChange={(e) => handleFieldChange('contract_date', e.target.value)}
                        required
                        data-testid="contract-date-input"
                        className="mt-1"
                      />
                      <p className="text-sm text-neutral-500 mt-1">
                        üí° –ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (01, 02, 010, 0110...)
                      </p>
                    </div>
                  </div>
                </div>

                {/* Landlord Info */}
                <div className="space-y-4">
                  <h3 className="font-semibold text-neutral-900 border-b pb-2">–ù–∞–π–º–æ–¥–∞—Ç–µ–ª—å (–í—ã)</h3>
                  <div>
                    <Label htmlFor="landlord_name">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ *</Label>
                    <Input
                      id="landlord_name"
                      value={templateData.landlord_name}
                      onChange={(e) => handleFieldChange('landlord_name', e.target.value)}
                      required
                      data-testid="landlord-name-input"
                      className="mt-1"
                    />
                  </div>
                  <div>
                    <Label htmlFor="landlord_representative">–ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å (–∫—Ç–æ —Å–æ—Å—Ç–∞–≤–∏–ª –¥–æ–≥–æ–≤–æ—Ä) *</Label>
                    <Input
                      id="landlord_representative"
                      value={templateData.landlord_representative}
                      onChange={(e) => handleFieldChange('landlord_representative', e.target.value)}
                      required
                      data-testid="landlord-rep-input"
                      className="mt-1"
                      placeholder="–§–ò–û"
                    />
                  </div>
                </div>

                {/* Dynamic Template Fields */}
                {selectedTemplate && selectedTemplate.placeholders && Object.keys(selectedTemplate.placeholders).length > 0 && (
                  <div className="space-y-4 p-6 bg-gradient-to-br from-blue-50/50 to-purple-50/50 border-2 border-dashed border-blue-200 rounded-xl">
                    <div className="border-b pb-2">
                      <h3 className="font-semibold text-neutral-900 flex items-center gap-2">
                        üìã –ü–æ–ª—è —à–∞–±–ª–æ–Ω–∞ "{selectedTemplate.title}"
                      </h3>
                      <p className="text-xs text-neutral-600 mt-1">
                        –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è –¥–ª—è –¥–æ–≥–æ–≤–æ—Ä–∞
                      </p>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {Object.entries(selectedTemplate.placeholders).map(([key, config]) => {
                        // Skip calculated fields - they will be computed automatically
                        if (config.type === 'calculated') return null;
                        
                        return (
                          <div key={key} className={config.type === 'text' ? 'md:col-span-2' : ''}>
                            <Label htmlFor={`placeholder_${key}`}>
                              {config.label} {config.required && <span className="text-red-500">*</span>}
                            </Label>
                            
                            {config.type === 'text' && (
                              <Input
                                id={`placeholder_${key}`}
                                value={placeholderValues[key] || ''}
                                onChange={(e) => setPlaceholderValues({...placeholderValues, [key]: e.target.value})}
                                required={config.required}
                                className="mt-1"
                                placeholder={`–í–≤–µ–¥–∏—Ç–µ ${config.label.toLowerCase()}`}
                              />
                            )}
                            
                            {config.type === 'number' && (
                              <Input
                                id={`placeholder_${key}`}
                                type="number"
                                value={placeholderValues[key] || ''}
                                onChange={(e) => setPlaceholderValues({...placeholderValues, [key]: e.target.value})}
                                required={config.required}
                                className="mt-1"
                                placeholder={`–í–≤–µ–¥–∏—Ç–µ ${config.label.toLowerCase()}`}
                              />
                            )}
                            
                            {config.type === 'date' && (
                              <Input
                                id={`placeholder_${key}`}
                                type="date"
                                value={placeholderValues[key] || ''}
                                onChange={(e) => setPlaceholderValues({...placeholderValues, [key]: e.target.value})}
                                required={config.required}
                                className="mt-1"
                              />
                            )}
                            
                            {config.type === 'phone' && (
                              <IMaskInput
                                mask="+7 (000) 000-00-00"
                                value={placeholderValues[key] || ''}
                                onAccept={(value) => setPlaceholderValues({...placeholderValues, [key]: value})}
                                placeholder="+7 (___) ___-__-__"
                                className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 mt-1"
                                id={`placeholder_${key}`}
                                type="tel"
                              />
                            )}
                            
                            {config.type === 'email' && (
                              <Input
                                id={`placeholder_${key}`}
                                type="email"
                                value={placeholderValues[key] || ''}
                                onChange={(e) => setPlaceholderValues({...placeholderValues, [key]: e.target.value})}
                                required={config.required}
                                className="mt-1"
                                placeholder={`–í–≤–µ–¥–∏—Ç–µ ${config.label.toLowerCase()}`}
                              />
                            )}
                          </div>
                        );
                      })}
                    </div>

                    {/* Tenant Document Upload (if required by template) */}
                    {selectedTemplate.requires_tenant_document && (
                      <div className="mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                        <Label className="font-semibold text-amber-900">
                          üìÑ –£–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–∏ –Ω–∞–Ω–∏–º–∞—Ç–µ–ª—è
                        </Label>
                        <p className="text-xs text-amber-700 mt-1 mb-3">
                          –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ –Ω–∞–Ω–∏–º–∞—Ç–µ–ª—è —Å–µ–π—á–∞—Å (–µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–ø–∏—è), 
                          –∏–ª–∏ –Ω–∞–Ω–∏–º–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∑–∏—Ç –µ–≥–æ –ø—Ä–∏ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏
                        </p>
                        
                        <div className="flex gap-2 items-center">
                          <Input
                            type="file"
                            accept="image/*,application/pdf"
                            onChange={(e) => {
                              const file = e.target.files[0];
                              if (file) {
                                setTenantDocument(file);
                                // Create preview
                                const reader = new FileReader();
                                reader.onload = () => setTenantDocPreview(reader.result);
                                reader.readAsDataURL(file);
                                toast.success('–î–æ–∫—É–º–µ–Ω—Ç –≤—ã–±—Ä–∞–Ω');
                              }
                            }}
                            className="flex-1"
                          />
                          {tenantDocument && (
                            <Button
                              type="button"
                              variant="outline"
                              size="sm"
                              onClick={() => {
                                setTenantDocument(null);
                                setTenantDocPreview(null);
                              }}
                            >
                              –£–¥–∞–ª–∏—Ç—å
                            </Button>
                          )}
                        </div>
                        
                        {tenantDocPreview && (
                          <div className="mt-2">
                            <p className="text-xs text-green-600">‚úì –î–æ–∫—É–º–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω: {tenantDocument.name}</p>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                )}

                {/* Tenant Info - Optional Fields (only show if no template selected) */}
                {!selectedTemplate && (
                  <div className="space-y-4">
                    <div className="flex items-center justify-between border-b pb-2">
                      <div>
                        <h3 className="font-semibold text-neutral-900">–ù–∞–Ω–∏–º–∞—Ç–µ–ª—å (–ö–ª–∏–µ–Ω—Ç)</h3>
                        <p className="text-xs text-neutral-500">–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è - –∫–ª–∏–µ–Ω—Ç –∑–∞–ø–æ–ª–Ω–∏—Ç –ø—Ä–∏ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏</p>
                      </div>
                      <Button
                        type="button"
                        variant="ghost"
                        size="sm"
                        onClick={() => setShowOptionalFields(!showOptionalFields)}
                        className="text-sm"
                      >
                        {showOptionalFields ? '‚ñº –°–∫—Ä—ã—Ç—å' : '‚ñ∂ –ü–æ–∫–∞–∑–∞—Ç—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–ª—è'}
                      </Button>
                    </div>
                  
                  {showOptionalFields && (
                    <div className="space-y-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                      <div>
                        <Label htmlFor="tenant_name">–§–ò–û –Ω–∞–Ω–∏–º–∞—Ç–µ–ª—è</Label>
                        <Input
                          id="tenant_name"
                          value={templateData.tenant_name}
                          onChange={(e) => handleFieldChange('tenant_name', e.target.value)}
                          data-testid="tenant-name-input"
                          className="mt-1"
                          placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∑–∞–ø–æ–ª–Ω–∏—Ç —Å–∞–º"
                        />
                      </div>
                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <Label htmlFor="tenant_phone">–¢–µ–ª–µ—Ñ–æ–Ω</Label>
                          <IMaskInput
                            mask="+7 (000) 000-00-00"
                            value={templateData.tenant_phone}
                            onAccept={(value) => handleFieldChange('tenant_phone', value)}
                            placeholder="+7 (___) ___-__-__"
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 mt-1"
                            id="tenant_phone"
                            type="tel"
                            data-testid="tenant-phone-input"
                          />
                        </div>
                        <div>
                          <Label htmlFor="tenant_email">Email</Label>
                          <Input
                            id="tenant_email"
                            type="email"
                            value={templateData.tenant_email}
                            onChange={(e) => handleFieldChange('tenant_email', e.target.value)}
                            data-testid="tenant-email-input"
                            className="mt-1"
                            placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ"
                          />
                        </div>
                      </div>
                      
                      <div>
                        <Label>–£–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</Label>
                        <p className="text-xs text-neutral-500 mb-3">–ï—Å–ª–∏ –µ—Å—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –∫–ª–∏–µ–Ω—Ç–∞, –º–æ–∂–µ—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å. –ò–Ω–∞—á–µ –∫–ª–∏–µ–Ω—Ç –∑–∞–≥—Ä—É–∑–∏—Ç —Å–∞–º.</p>
                        
                        {tenantDocPreview && (
                          <div className="mb-6">
                            <div className="bg-green-50 border-l-4 border-green-500 p-3 rounded-r mb-4">
                              <div className="flex items-center gap-2 text-green-800">
                                <CheckCircle className="h-5 w-5" />
                                <span className="font-semibold">–î–æ–∫—É–º–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ</span>
                              </div>
                            </div>
                            <div className="mb-4">
                              <img
                                src={tenantDocPreview}
                                alt=""
                                className="w-full rounded-lg border-2 border-green-200 shadow-md block"
                              />
                            </div>
                          </div>
                        )}
                        
                        <Label htmlFor="tenant_doc" className="cursor-pointer">
                          <Button type="button" variant="outline" className="w-full" asChild>
                            <span>
                              <Upload className="mr-2 h-4 w-4" />
                              {tenantDocument ? '–ò–∑–º–µ–Ω–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –∫–ª–∏–µ–Ω—Ç–∞' : '–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –∫–ª–∏–µ–Ω—Ç–∞'}
                            </span>
                          </Button>
                          <Input
                            id="tenant_doc"
                            type="file"
                            accept="image/*,.pdf"
                            onChange={handleTenantDocUpload}
                            className="hidden"
                          />
                        </Label>
                        <p className="text-xs text-neutral-500 mt-1">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: JPEG, PNG, PDF</p>
                      </div>
                    </div>
                  )}
                  </div>
                )}

                {/* Property Details (only show if no template selected) */}
                {!selectedTemplate && (
                <div className="space-y-4">
                  <h3 className="font-semibold text-neutral-900 border-b pb-2">–û–ø–∏—Å–∞–Ω–∏–µ –∏ –∞–¥—Ä–µ—Å –∫–≤–∞—Ä—Ç–∏—Ä—ã</h3>
                  <div>
                    <Label htmlFor="property_address">–ê–¥—Ä–µ—Å –∫–≤–∞—Ä—Ç–∏—Ä—ã *</Label>
                    <Input
                      id="property_address"
                      value={templateData.property_address}
                      onChange={(e) => handleFieldChange('property_address', e.target.value)}
                      required
                      data-testid="property-address-input"
                      className="mt-1"
                      placeholder="–≥. –ê–ª–º–∞—Ç—ã, —É–ª. ..."
                    />
                  </div>
                </div>
                )}

                {/* Financial Terms */}
                {!selectedTemplate && (
                <div className="space-y-4">
                  <h3 className="font-semibold text-neutral-900 border-b pb-2">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è</h3>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <Label htmlFor="rent_amount">–¶–µ–Ω–∞ –≤ —Å—É—Ç–∫–∏ *</Label>
                      <Input
                        id="rent_amount"
                        type="number"
                        value={templateData.rent_amount}
                        onChange={(e) => handleFieldChange('rent_amount', e.target.value)}
                        required
                        data-testid="rent-amount-input"
                        className="mt-1"
                        placeholder="10000"
                      />
                    </div>
                    <div>
                      <Label htmlFor="security_deposit">–û–±–µ—Å–ø–µ—á–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç</Label>
                      <Input
                        id="security_deposit"
                        type="number"
                        value={templateData.security_deposit}
                        onChange={(e) => handleFieldChange('security_deposit', e.target.value)}
                        data-testid="security-deposit-input"
                        className="mt-1"
                        placeholder="5000"
                      />
                    </div>
                  </div>
                  <div>
                    <Label htmlFor="days_count">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—É—Ç–æ–∫ (—Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)</Label>
                    <Input
                      id="days_count"
                      type="number"
                      value={templateData.days_count}
                      readOnly
                      disabled
                      data-testid="days-count-input"
                      className="mt-1 bg-neutral-100 cursor-not-allowed"
                    />
                    <p className="text-xs text-neutral-500 mt-1">–° 14:00 –¥–∞—Ç—ã –∑–∞—Å–µ–ª–µ–Ω–∏—è –¥–æ 12:00 –¥–∞—Ç—ã –≤—ã—Å–µ–ª–µ–Ω–∏—è</p>
                  </div>
                  {templateData.rent_amount && templateData.days_count && (
                    <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                      <p className="text-sm text-blue-900">
                        <strong>–ü–æ–ª–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</strong> {parseInt(templateData.rent_amount) * parseInt(templateData.days_count)} {templateData.rent_currency}
                      </p>
                    </div>
                  )}
                </div>
                )}

                {/* Dates */}
                {!selectedTemplate && (
                <div className="space-y-4">
                  <h3 className="font-semibold text-neutral-900 border-b pb-2">–î–∞—Ç—ã –∑–∞—Å–µ–ª–µ–Ω–∏—è –∏ –≤—ã—Å–µ–ª–µ–Ω–∏—è</h3>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <Label htmlFor="move_in_date">–î–∞—Ç–∞ –∑–∞—Å–µ–ª–µ–Ω–∏—è *</Label>
                      <Input
                        id="move_in_date"
                        type="date"
                        value={templateData.move_in_date}
                        onChange={(e) => handleFieldChange('move_in_date', e.target.value)}
                        required
                        data-testid="move-in-date-input"
                        className="mt-1"
                      />
                    </div>
                    <div>
                      <Label htmlFor="move_out_date">–î–∞—Ç–∞ –≤—ã—Å–µ–ª–µ–Ω–∏—è *</Label>
                      <Input
                        id="move_out_date"
                        type="date"
                        value={templateData.move_out_date}
                        onChange={(e) => handleFieldChange('move_out_date', e.target.value)}
                        required
                        data-testid="move-out-date-input"
                        className="mt-1"
                      />
                    </div>
                  </div>
                </div>
                )}

                {/* Submit Buttons */}
                <div className="flex gap-3 pt-4 border-t">
                  <Button
                    type="submit"
                    disabled={loading}
                    data-testid="save-contract-button"
                    className="flex-1"
                  >
                    {loading ? t('common.loading') : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä'}
                  </Button>
                  <Button
                    type="button"
                    variant="outline"
                    onClick={() => navigate('/dashboard')}
                    data-testid="cancel-button"
                  >
                    {t('common.cancel')}
                  </Button>
                </div>
              </form>
            </CardContent>
          </Card>
        </div>
      </div>
    </div>
  );
};

export default CreateContractPage;